---
category: perl
layout: post
tags:
  - Catalyst
  - TheSchwartz
title: use TheSchwartz job queue to handle Image-Resize For Catalyst App.
---
{% include JB/setup %}

<a href='http://search.cpan.org/perldoc?TheSchwartz'>TheSchwartz</a> - reliable job queue. original developped by <a href='http://www.danga.com'>Brad</a> and used in <a href='http://www.livejournal.com'>LiveJournal</a>.<br /><br />My main aim is to remove 'Image::Magick' out of my Catalyst App since Image::Magick takes a lot of memories for every process under mod_perl. so we need a non-stop cron script to monitor and resize photos. and I picked TheSchwartz up for my Foorum Catalyst App.<br /><br />Here comes the instructions:<br /><br />1, create db 'theschwartz' by using schema: <a href='http://search.cpan.org/src/BRADFITZ/TheSchwartz-1.04/doc/schema.sql'>http://search.cpan.org/src/BRADFITZ/TheSchwartz-1.04/doc/schema.sql</a><br /><br />2, write the main module <a href='http://fayland.googlecode.com/svn/trunk/Foorum/lib/Foorum/TheSchwartz/Worker/ResizeProfilePhoto.pm'>Foorum::TheSchwartz::Worker::ResizeProfilePhoto</a> use base <a href='http://search.cpan.org/perldoc?TheSchwartz::Worker'>TheSchwartz::Worker</a>.<pre>package Foorum::TheSchwartz::Worker::ResizeProfilePhoto;<br /><br />use TheSchwartz::Job;<br />use base qw( TheSchwartz::Worker );<br />use Foorum::ExternalUtils qw/schema/;<br />use File::Spec;<br />use Image::Magick;<br />use Cwd qw/abs_path/;<br />use File::Copy;<br /><br />my (undef, $path) = File::Spec->splitpath(__FILE__);<br /><br />sub work {<br />    my $class = shift;<br />    my TheSchwartz::Job $job = shift;<br />    <br />    my @args = $job->arg;<br />    <br />    my $schema = schema();<br /><br />    # get upload from db<br />    my $upload_id = shift @args;<br />    if ($upload_id !~ /^\d+$/) {<br />        return $job->failed("Wrong upload_id: $upload_id");<br />    }<br />    my $upload = $schema->resultset('Upload')->find( { upload_id => $upload_id } );<br />    unless ($upload) {<br />        return $job->failed("No upload for $upload_id");<br />    }<br />    <br />    # get file dir<br />    my $directory_1 = int( $upload_id / 3200 / 3200 );<br />    my $directory_2 = int( $upload_id / 3200 );<br />    my $file = abs_path("$path/../../../../root/upload/$directory_1/$directory_2/" . $upload->filename);<br />    <br />    # resize photo<br />    my $p = new Image::Magick;<br />    $p->Read($file);<br />    $p->Scale(geometry=>'120x120');<br />    $p->Sharpen(geometry=>'0.0x1.0');<br />    $p->Set(quality=>'75');<br />    <br />    my ($width, $height, $size) = $p->Get('width', 'height', 'filesize');<br />    <br />    my $tmp_file = $file . '.tmp';<br />    $p->Write($tmp_file);<br />    <br />    move($tmp_file, $file);<br />    <br />    # update db<br />    $schema->resultset('UserProfilePhoto')->search( {<br />        type    => 'upload',<br />        value   => $upload_id,<br />    } )->update( {<br />        width  => $width,<br />        height => $height,<br />    } );<br />    ($size) = ( $size =~ /^(\d+\.?\d{0,1})/ );    # float(6,1)<br />    $upload->update( { filesize => $size } );<br /><br />    $job->completed();<br />}<br /><br />sub max_retries { 3 };<br /><br />1;</pre><br /><br />3, write a <a href='http://fayland.googlecode.com/svn/trunk/Foorum/bin/cron/TheSchwartz_worker.pl'>TheSchwartz_worker.pl</a> and run it. it will monitor the "job" table in "theschwartz" database non-stop.<pre>package <a href='http://fayland.googlecode.com/svn/trunk/Foorum/lib/Foorum/ExternalUtils.pm'>Foorum::ExternalUtils</a>;<br /># ... etc.<br />use TheSchwartz;<br />sub theschwartz {<br />    <br />    $config = config() unless ($config);<br />    <br />    my $theschwartz = TheSchwartz->new(<br />        databases => [ {<br />            dsn  => $config->{theschwartz_dsn}, # dbi:mysql:theschwartz<br />            user => $config->{dsn_user},<br />            pass => $config->{dsn_pwd},<br />        } ],<br />        verbose => 1,<br />    );<br />    return $theschwartz;<br />}<br /></pre><pre>use Foorum::ExternalUtils qw/theschwartz/;<br />use Foorum::TheSchwartz::Worker::ResizeProfilePhoto;<br /><br />my $client = theschwartz();<br />$client->can_do('Foorum::TheSchwartz::Worker::ResizeProfilePhoto');<br />$client->work();</pre><br /><br />4, at last, we need insert data into 'job' table then let TheSchwartz_worker.pl to handle it.<pre>package <a href='http://fayland.googlecode.com/svn/trunk/Foorum/lib/Foorum/Controller/Profile.pm'>Foorum::Controller::Profile</a>;<br />use Foorum::ExternalUtils qw/theschwartz/;<br />sub xxx : Local {<br />    # ... etc.<br />    my $client = theschwartz();<br />    $client->insert('Foorum::TheSchwartz::Worker::ResizeProfilePhoto', $new_upload_id);<br />}</pre><br /><br />That's ALL.<br /><br />The idea behind TheSchwartz is not so complicate.<br /><ul><br /><li>the "theschwartz" database contains 5 tables:<br />    <ul><br />    <li>'error' for recording error for every failed job. like in Foorum::TheSchwartz::Worker::ResizeProfilePhoto, $job->failed("No upload for $upload_id");</li><br />    <li>'funcmap' has two columns: on is funcid and the other is funcname. It's pretty simple. when we call "$client->can_do('Foorum::TheSchwartz::Worker::ResizeProfilePhoto');" in TheSchwartz_worker.pl, it will create a new row ($auto_increasing_func_id, 'Foorum::TheSchwartz::Worker::ResizeProfilePhoto') if there hasn't</li><br />    <li>'job' is the most important table here. TheSchwartz_worker.pl monitor this table every 5 secs. and if $client->insert one job, it will work_once() immediately.</li><br />    <li>other two tables: exitstatus and notes</li><br />    </ul><br /><li>TheSchwartz_worker.pl can tell what jobs it can handle by using "$client->can_do('Foorum::TheSchwartz::Worker::ResizeProfilePhoto');". add this line means that TheSchwartz_worker.pl can do the jobs which the "funcid" in "job" table is mapping with 'Foorum::TheSchwartz::Worker::ResizeProfilePhoto'.</li><br /><li>TheSchwartz_worker.pl is a non-stop script to monitor the "job" table every 5 secs. if there are jobs, it will work_once() one by one.</li><br /><li>$client->insert('Foorum::TheSchwartz::Worker::ResizeProfilePhoto', $new_upload_id); it inserts one row in 'job' table then let worker.pl to handle it. 'Foorum::TheSchwartz::Worker::ResizeProfilePhoto' is the funcname, and $new_upload_id is the args.<br />in package Foorum::TheSchwartz::Worker::ResizeProfilePhoto; we need use base TheSchwartz::Worker and write a sub work. <br /><pre>sub work {<br />    my $class = shift;<br />    my TheSchwartz::Job $job = shift;<br />    <br />    my @args = $job->arg;<br />    <br />    # do something<br />    <br />    $job->completed();<br />}</pre></li><br /><li>If u want another worker:<br />just write package Foorum::TheSchwartz::Worker::Another<br />then in TheSchwartz_worker.pl use it and add $client->can_do('Foorum::TheSchwartz::Worker::Another');<br />then in pl or pm. $client->insert('Foorum::TheSchwartz::Worker::Another', @args);<br /></li><br /></ul><br /><br />That's ALL. @Enjoy;