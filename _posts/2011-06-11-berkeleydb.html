---
category: perl
layout: post
tags:
  - BerkeleyDB
  - fork
  - perl
title: BerkeleyDB
---
{% include JB/setup %}

<a href="http://search.cpan.org/perldoc?BerkeleyDB">BerkeleyDB</a> is quit popular and nice to use.<div><br /></div><div>there is one interesting article from&nbsp;<u>The Architecture of Open Source Applications</u>&nbsp;worth reading:&nbsp;<a href="http://www.aosabook.org/en/bdb.html" style="text-decoration: underline; ">http://www.aosabook.org/en/bdb.html</a></div><div><br /></div><div>BerkeleyDB is not available under Windows. and usually you can use apt-get or yum to install it on Linux, eg: $ sudo&nbsp;apt-get install libberkeleydb-perl</div><div><br /></div><div>all the modules are usually down to "When to use it?" and "How to use it?".</div><div><br /></div><div>BerkeleyDB is suitable when you meet:</div><div>1. you have a VERY big file and you want&nbsp;manipulate it like remove duplication lines or sort on string inside each line. but you don't have enough memory.</div><div>2. you want to share data in 'forks'. that can be an option.</div><div>3. and more ...</div><div><br /></div><div><b>Case A</b>: you have enough disk, but limited memory</div><div><br /></div><blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><div>use FindBin qw/$Bin/;</div><div>use BerkeleyDB;</div></div><div><br /></div><div>my $berkeleydb_temp_file = "$Bin/tmp.berkeleydb"; # temp file for BerkeleyDB</div><div><div>tie my %data, 'BerkeleyDB::Hash',</div><div>&nbsp; &nbsp; -Filename =&gt; $berkeleydb_temp_file,</div><div>&nbsp; &nbsp; -Flags &nbsp; &nbsp;=&gt; DB_CREATE|DB_TRUNCATE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; or die "Cannot create file: $! $BerkeleyDB::Error\n";</div></div><div><div>open(my $fh, '&lt;', 'RealBigFile.log') or die "Can't open: $!";</div><div>while (my $line = &lt;$fh&gt;) {</div></div><div>&nbsp; &nbsp; ## some code that %data will be a real very big hash</div><div>&nbsp; &nbsp; ## we just need the first line and the last line which matches the $pattern</div><div>&nbsp; &nbsp; my $pattern = get_pattern($line);</div><div>&nbsp; &nbsp; if (exists $data{"start_$pattern"}) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; $data{"end_$pattern"} = $line;</div><div>&nbsp; &nbsp; } else {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; $data{"start_$pattern"} = $line;</div><div>&nbsp; &nbsp; }</div><div>}</div><div>close($fh);</div><div># now working on the %data</div><div><br /></div></blockquote><b>Case B</b>: in forks<div>I shared some thoughts on <a href="http://blog.fayland.org/2011/01/tips-around-parallelforkmanager.html">tips around Parallel::ForkManager</a>&nbsp;previously. in that article, I suggested&nbsp;Parallel::Scoreboard and Cache::FastMmap. but really,&nbsp;BerkeleyDB is a good choice too.</div><div><br /></div><div>but that's not so easy to write the correct code from the first glance. if you don't use&nbsp;cds_lock, you may get some wrong results. I wrote two tests (hosted on github):</div><div><a href="https://github.com/fayland/fayland.org/blob/master/blogs/wrong-forks-BerkeleyDB.t">https://github.com/fayland/fayland.org/blob/master/blogs/wrong-forks-BerkeleyDB.t</a></div><div><a href="https://github.com/fayland/fayland.org/blob/master/blogs/right-forks-BerkeleyDB.t">https://github.com/fayland/fayland.org/blob/master/blogs/right-forks-BerkeleyDB.t</a></div><div><br /></div><blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><div>fayland@fayland:~/git/fayland.org/blogs$ perl right-forks-BerkeleyDB.t</div><div>ok 1</div><div>1..1</div><div>fayland@fayland:~/git/fayland.org/blogs$ perl wrong-forks-BerkeleyDB.t</div><div>not ok 1</div><div># &nbsp; Failed test at wrong-forks-BerkeleyDB.t line 30.</div><div># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;got: '656'</div><div># &nbsp; &nbsp; expected: '1000'</div><div>1..1</div><div># Looks like you failed 1 test of 1.</div><div>fayland@fayland:~/git/fayland.org/blogs$ perl right-forks-BerkeleyDB.t</div><div>ok 1</div><div>1..1</div><div>fayland@fayland:~/git/fayland.org/blogs$ perl wrong-forks-BerkeleyDB.t</div><div>not ok 1</div><div># &nbsp; Failed test at wrong-forks-BerkeleyDB.t line 30.</div><div># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;got: '661'</div><div># &nbsp; &nbsp; expected: '1000'</div><div>1..1</div><div># Looks like you failed 1 test of 1.</div></div></blockquote><br /><div>without the lock, you may get some weird results.</div><div><br /></div><div>snippets code below:</div><div><br /></div><blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><div><div>my $env = new BerkeleyDB::Env</div><div>&nbsp; &nbsp; -Home &nbsp; =&gt; $tmp_dir,</div><div>&nbsp; &nbsp; -Flags &nbsp;=&gt; DB_CREATE|DB_INIT_CDB|DB_INIT_MPOOL</div><div>&nbsp; &nbsp; &nbsp; &nbsp; or die "cannot open environment: $BerkeleyDB::Error\n";</div></div><div><div>my $db = tie my %data, 'BerkeleyDB::Hash',</div><div>&nbsp; &nbsp; -Filename =&gt; $berkeleydb_temp_file,</div><div>&nbsp; &nbsp; -Flags &nbsp; &nbsp;=&gt; DB_CREATE,</div><div>&nbsp; &nbsp; -Env &nbsp; &nbsp; &nbsp;=&gt; $env</div><div>&nbsp; &nbsp; &nbsp; &nbsp; or die "Cannot create file: $! $BerkeleyDB::Error\n";</div></div><div><br /></div><div>my $lock = $db-&gt;cds_lock();</div><div>$data{$i} = $i * 2;</div><div>$db-&gt;db_sync();</div><div>$lock-&gt;cds_unlock();</div></div><div><br /></div></blockquote>BerkeleyDB is not only for Hash, it also supports&nbsp;Btree,&nbsp;Recno,&nbsp;Queue and others.<div><br /></div><div>I hope it helps when you meet same issues in your daily life.</div><div><br /></div><div>Enjoy, Thanks</div>