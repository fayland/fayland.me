---
category: perl
layout: post
tags: []
title: Catalyst &amp;&amp; XML-RPC
---
{% include JB/setup %}

今天因为用到了这个模块，所以就在这里提一下。如果你有机会碰到同样的问题可以参考一下。<p />因为 <a href="http://blog.chunzi.org">chunzi</a> 有很多工作要做，而我又有点空加上想锻炼下自己。所以就配合他写 <a href='http://memebr.perlchina.org'>member.perlchina</a> 的代码。<br />代码块中有一功能是用户认证 API, 当然这个很复杂。首先需要一个详细的 SPEC 规格文档。<br />就目前处于没有文档的情况下，我就先试着用 XMLRPC 来写一个远程验证 API. 待文档确定后再修补。<p /><a href="http://dev.catalyst.perl.org">Catalyst</a> 用于 RPC 有一 plugin 为 <a href="http://search.cpan.org/perldoc?Catalyst::Plugin::XMLRPC">Catalyst::Plugin::XMLRPC</a> , 它是以 <a href="http://search.cpan.org/perldoc?RPC::XML">RPC::XML</a> 为基础的一个插件。<br />doc 很简单。唯一要注意的是要写在 use Catalyst qw/XMLRPC/; 同一文件里。<p />以代码为例：<br /><pre># 主程序模块文件（use Catalyst qw/XMLRPC）那文件，添加<p /># 这与其他 Catalyst 的 Global 函数一样。定义了一个 rpc 方法。注意函数名不要为 xmlrpc, 这是插件的函数<br />sub rpc : Global {<br />    my ( $self, $c ) = @_;<br />    $c->xmlrpc;<br />}<p /># 所有方法后面带有 : Remote 的都是 XMLRPC 方法<br />sub auth : Remote {<br />    my ( $self, $c, @args ) = @_;<br />    return 'ERR_ARG_COUNT' if (scalar @args != 2);<br />    my ($username, $password) = @args;<br />    <br />    # 这里调用的是模块里自己定义的一个函数 auth, 你可以自己写 CDBI 代码<br />    my $person = Person::M::CDBI::Person->auth( $username, $password );<br />    <br />    return 'ERR_LOGIN_FAILED' unless ($person);<br />    return 'ERR_UNACTIVED' unless ($person->has_actived);<br />    <br />    return 'SUCCUSS';<br />}</pre>而验证代码我们可以简单写一下：<br /><pre>#!/usr/bin/perl<br />use strict;<br />use warnings;<br />use Data::Dumper;<br />use RPC::XML;<br />use RPC::XML::Client;<p />my $cli = RPC::XML::Client->new('http://fayland:3000/rpc'); # XMLRPC 地址<p />my $request = RPC::XML::request->new('auth', 'fayland', '123456'); # 方法名和两个参数<p />my $response = $cli->simple_request($request);<p />if (!$response) {<br />    print "$RPC::XML::ERROR \n"; # No response<br />}<br />else {<br />    print Dumper($response);<br />}</pre>这是访问的一种方法，其他的可以参考 <a href='xml-rpc-client.html'>XML-PRC Client 客户端编写</a>。<p />Enjoy!