---
category: perl
layout: post
tags: []
title: Catalyst and FormValidator::Simple
---
{% include JB/setup %}

检验用户输入信息的正确性几乎是所有 Web 编程者都需要做的事。有句话是永远不要相信你的用户。每一个用户都可能是骇客。<br />Catalyst 中我最喜欢的检测插件是 <a href='http://search.cpan.org/perldoc?Catalyst::Plugin::FormValidator::Simple'>Catalyst::Plugin::FormValidator::Simple</a><br />我可以用个简单一点的例子来说明一下。<br /><br />假设最简单的用户注册。一个用户名 6-12 个字符。密码 6-20 个，输入两次，两次都一样。 email 一个。要求大致正确。用户名和 email 必须与数据库里已有的不冲突。<br />Controller 大致为这样子：<pre>sub register : Global {<br />    my ( $self, $c ) = @_;<br /> <br />    $c->stash->{template} = 'user/register.html';<br /> <br />    return unless ($c->req->param('process'));<br /> <br />    # execute validation.<br />    $c->form(<br />        username  => [[ 'DBIC_UNIQUE', $c->model('DBIC')->resultset('User'), 'username' ], qw/NOT_BLANK ASCII/,       [qw/LENGTH 6 20/] ],<br />        password  => [qw/NOT_BLANK/,             [qw/LENGTH 6 12/] ],<br />        email     => [qw/NOT_BLANK EMAIL_LOOSE/, [qw/LENGTH 5 20/], [ 'DBIC_UNIQUE', $c->model('DBIC')->resultset('User'), 'email' ] ],<br />        { passwords => ['password', 'confirm_password'] } => ['DUPLICATION'],<br />    );<br /><br />    my $result = $c->form;<br />    return if ( $result->has_error );</pre>$c->form 就是 Catalyst::Plugin::FormValidator::Simple 所提供的函数。DBIC_UNIQUE 检验机制是由 <a href='http://search.cpan.org/perldoc?FormValidator::Simple::Plugin::DBIC::Unique'>FormValidator::Simple::Plugin::DBIC::Unique </a> 所提供的。主要用于检测表中的某一字段是否是 unique 独一的。我们所看到的如 NOT_BLANK LENGTH EMAIL_LOOSE DUPLICATION 都是 <a href='http://search.cpan.org/perldoc?FormValidator::Simple'>FormValidator::Simple</a> 所自带的检测机制。还有 DATE 用于检测输入的日期是否合法，Regex 等。可以查阅 perldoc FormValidator::Simple<br />上面的是检查，然后如果出错要把错误显示出来。这里我觉得有点不方便。比如说 username 到底是违反了哪一条。 $c->form->error('username') 返回的是一个匿名数组，如 [ 'DBIC_UNIQUE', 'LENGTH' ] 我的习惯是将错误消息显示在 username text 输入框的旁边，而不是把所有的错误消息都放一起。这样判断起来很麻烦。我差不多得这么写：<pre>&lt;input type='text' name='username' length='12' /><br />    [% FOREACH type IN c.form.error('username') %]<br />        [% IF type == 'DBIC_UNIQUE' %]<br />        This username is used by another one.<br />        [% END %]<br />        ....<br />    [% END %]</pre>这种是比较愚笨的方法。我对这个也没用过几次，所以可能有好办法还没发现。perldoc 中提到了用 yml 来定义错误信息，或者这个比较可行，但是我不太喜欢，因为我在做多语言版本的 Forum<br /><br />或许我得再仔细研究下错误怎么显示才是最方便的。:) later~<br /><br /><b>update</b><br />我发现这样子是可行的：<pre> [% IF c.form.error('username') %]<br />     [% IF IF c.form.error('username', 'DBIC_UNIQUE') %]<br />     This username is used by another one.<br />     [% ELSE %]<br />     username should be 6-20 chars.<br />     [% END %]<br /> [% END %]</pre>