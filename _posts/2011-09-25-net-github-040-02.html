---
category: perl
layout: post
tags:
  - CPAN
  - Git
  - GitHub
  - Moose
  - perl
title: Net-GitHub 0.40_02
---
{% include JB/setup %}

it's a story following the <a href="http://blog.fayland.org/2011/09/net-github-040-01.html">previous one</a>. and this one will be shorter.<div><br /></div><div>I got Net-GitHub 0.40_02 released few minutes ago. with</div><div>* Gists, Git Data, Orgs supports</div><div>* methods on fly</div><div><br /></div><div>there are still something to do like Pagination and MIME-Types. but most of the functions should be working now.</div><div><br /></div><div>big thanks to <a href="https://metacpan.org/module/Moose">Moose</a> team, I becomes a little smarter than yesterday.</div><div><br /></div><div>yesterday I was dumb. I wrote every methods with sub, with arguments fix, with -&gt;query or check DELETE status. lots of duplication codes.</div><div><br /></div><div>I cleaned all the code up with __PACKAGE__-&gt;meta-&gt;add_method. now all the code looks very clean and easy to maintain.</div><div><br /></div><div>old code looks like (<a href="https://github.com/fayland/perl-net-github/blob/3c7cb3393834d5dd5d5bc4b583fcb1669ef8ef2d/lib/Net/GitHub/V3/PullRequests.pm">https://github.com/fayland/perl-net-github/blob/3c7cb3393834d5dd5d5bc4b583fcb1669ef8ef2d/lib/Net/GitHub/V3/PullRequests.pm</a>)</div><div><br /></div><div>new code is really much better:&nbsp;<a href="https://github.com/fayland/perl-net-github/blob/master/lib/Net/GitHub/V3/PullRequests.pm">https://github.com/fayland/perl-net-github/blob/master/lib/Net/GitHub/V3/PullRequests.pm</a></div><div><br /></div><div>the main tricky here is the -&gt;meta-&gt;add_method.</div><div><br /></div>## build methods on fly<br /><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><div>sub __build_methods {</div><div>&nbsp; &nbsp; my $package = shift;</div><div>&nbsp; &nbsp; my %methods = @_;</div><div>&nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; foreach my $m (keys %methods) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; my $v = $methods{$m};</div><div>&nbsp; &nbsp; &nbsp; &nbsp; my $url = $v-&gt;{url};</div><div>&nbsp; &nbsp; &nbsp; &nbsp; my $method = $v-&gt;{method} || 'GET';</div><div>&nbsp; &nbsp; &nbsp; &nbsp; my $args = $v-&gt;{args} || 0; # args for -&gt;query</div><div>&nbsp; &nbsp; &nbsp; &nbsp; my $check_status = $v-&gt;{check_status};</div><div>&nbsp; &nbsp; &nbsp; &nbsp; my $is_u_repo = $v-&gt;{is_u_repo}; # need auto shift u/repo</div><div>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; $package-&gt;meta-&gt;add_method( $m =&gt; sub {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; my $self = shift;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # count how much %s inside u</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; my $n = 0; while ($url =~ /\%s/g) { $n++ }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ## if is_u_repo, both ($user, $repo, @args) or (@args) should be supported</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ( ($is_u_repo or index($url, '/repos/%s/%s') &gt; -1) and @_ &lt; $n + $args) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unshift @_, ($self-&gt;u, $self-&gt;repo);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # make url, replace %s with real args</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; my @uargs = splice(@_, 0, $n);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; my $u = sprintf($url, @uargs);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # args for json data POST</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; my @qargs = $args ? splice(@_, 0, $args) : ();</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($check_status) { # need check Response Status</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; my $old_raw_response = $self-&gt;raw_response;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $self-&gt;raw_response(1); # need check header</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; my $res = $self-&gt;query($method, $u, @qargs);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $self-&gt;raw_response($old_raw_response);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return index($res-&gt;header('Status'), $check_status) &gt; -1 ? 1 : 0;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return $self-&gt;query($method, $u, @qargs);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; } );</div><div>&nbsp; &nbsp; }</div><div>}</div></div></blockquote><br /><div>next step will be Pagination and MIME-types. and later.</div><div><br /></div><div>Thanks</div>