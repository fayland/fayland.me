---
category: perl
layout: post
tags: []
title: "today's module: Scope::Guard"
---
{% include JB/setup %}

<i>Updated: Thanks for Eddy to point out the errors. :)</i><br /><br />I have been very happy with <a href="http://search.cpan.org/perldoc?Scope::Guard">Scope::Guard</a> recently.<br /><br />mainly the module can reduce the size of the code if you use it correctly.<br /><br />for example, we have some piece of code like follows to deal with Sphinx error.<pre><code>sub while_error {<br />    my ( $ret ) = @_;<br />    <br />    my $use_db = { use_db_please => 1 };<br />    <br />    # 1, connection to {localhost}:{3312} failed: Connection refused<br />    if ($ret->{error} =~ /Connection refused/is) {<br />       faked_try_to_reconnect();<br />       print STDERR "$ret->{error}\n";<br />       return $use_db;<br />    }<br />    # 2, received zero-sized searchd response<br />    elsif ($ret->{error} =~ /zero-sized searchd/) {<br />        faked_try_to_re_search();<br />        print STDERR "$ret->{error}\n";<br />        return $use_db;<br />    }<br />    # 3, unknown local index<br />    elsif ( $ret->{error} =~ /unknown local index/ ) {<br />        faked_try_to_re_index();<br />        print STDERR "$ret->{error}\n";<br />        return $use_db;<br />    }<br />    # 4, recv: Connection reset by peer<br />    elsif ( $ret->{error} =~ /Connection reset by peer/ ) {<br />        print STDERR "$ret->{error}\n";<br />        return $use_db;<br />    }<br />    return $ret;<br />}</code></pre>OK, it's not so ugly.<br />but with Scope::Guard, we can rewrite it much more clear and small-size.<pre><code>sub while_error {<br />    my ( $ret ) = @_;<br /><br />    my $use_db = { use_db_please => 1 };<br />    <br />    my $sg = Scope::Guard->new( sub {<br />        print STDERR "$ret->{error}\n";<br />    } );<br /><br />    # 1, connection to {localhost}:{3312} failed: Connection refused<br />    if ($ret->{error} =~ /Connection refused/is) {<br />       faked_try_to_reconnect();<br />       return $use_db;<br />    }<br />    # 2, received zero-sized searchd response<br />    elsif ($ret->{error} =~ /zero-sized searchd/) {<br />        faked_try_to_re_search();<br />        return $use_db;<br />    }<br />    # 3, unknown local index<br />    elsif ( $ret->{error} =~ /unknown local index/ ) {<br />        faked_try_to_re_index();<br />        return $use_db;<br />    }<br />    # 4, recv: Connection reset by peer<br />    elsif ( $ret->{error} =~ /Connection reset by peer/ ) {<br />        return $use_db;<br />    }<br />    <br />    $sg->dismiss();<br />    <br />    return $ret;<br />}</code></pre>I'm not sure if you're happy with it or not, but I like it. :)<br />I had used it in <a href="http://code.fayland.org/fayland/CPAN/day_day_up/lib/DayDayUp/Backup.pm">http://code.fayland.org/fayland/CPAN/day_day_up/lib/DayDayUp/Backup.pm</a>. that's just another example.<br /><br />Thanks and Enjoy!